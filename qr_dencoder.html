<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QR Code Utility (Generate & Decode)</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Load Inter font -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f9fb;
        }
    </style>
    <!-- Library for generating QR codes (SVG based) -->
    <script src="https://cdn.jsdelivr.net/npm/qrcode-svg@1.1.0/lib/qrcode.min.js"></script>
    <!-- Library for decoding QR codes from images -->
    <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js"></script>
</head>
<body class="min-h-screen p-4 md:p-8">

    <header class="text-center mb-10">
        <h1 class="text-4xl font-extrabold text-gray-900 mb-2">
            QR Code Utility
        </h1>
        <p class="text-xl text-gray-500">Generate or Decode QR Codes Instantly</p>
    </header>

    <main class="max-w-7xl mx-auto grid grid-cols-1 lg:grid-cols-2 gap-8">

        <!-- QR Code Generator Section -->
        <div class="bg-white p-6 md:p-8 rounded-xl shadow-2xl transition duration-300 hover:shadow-3xl border border-blue-100">
            <h2 class="text-2xl font-bold text-blue-700 mb-6 border-b pb-2">1. Generate QR Code (Text to Image)</h2>

            <div class="mb-4">
                <label for="qrInput" class="block text-sm font-medium text-gray-700 mb-1">Text or URL to Encode:</label>
                <textarea id="qrInput" rows="4" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 transition shadow-sm resize-none" placeholder="Enter the text, link, or data you want to embed in the QR code..."></textarea>
            </div>

            <button onclick="generateQRCode()" class="w-full px-4 py-3 bg-blue-600 text-white font-semibold rounded-lg hover:bg-blue-700 transition duration-150 shadow-md hover:shadow-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2">
                Generate QR Code
            </button>

            <div id="qrOutputContainer" class="mt-8 text-center bg-gray-50 p-4 rounded-lg border border-dashed border-gray-300 min-h-[250px] flex items-center justify-center">
                <p id="qrPlaceholder" class="text-gray-400">Your generated QR code will appear here.</p>
                <!-- Now serves as the container for the downloadable <img> element -->
                <div id="qrCodeSvg" class="hidden p-2 bg-white rounded-lg shadow-inner max-w-full">
                    <!-- The downloadable <img> will be inserted here -->
                </div>
            </div>
        </div>

        <!-- QR Code Decoder Section -->
        <div class="bg-white p-6 md:p-8 rounded-xl shadow-2xl transition duration-300 hover:shadow-3xl border border-green-100">
            <h2 class="text-2xl font-bold text-green-700 mb-6 border-b pb-2">2. Decode QR Code (Image to Text)</h2>

            <div class="mb-6 space-y-4">
                <input type="file" id="qrFile" accept="image/*" class="w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-green-50 file:text-green-700 hover:file:bg-green-100 transition" onchange="decodeQRCodeFromImage(event)">

                <div class="flex items-center justify-center">
                    <div class="w-full border-t border-gray-200"></div>
                    <span class="px-3 text-sm text-gray-500 bg-white">OR</span>
                    <div class="w-full border-t border-gray-200"></div>
                </div>

                <textarea id="qrPasteArea" rows="2" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-green-500 focus:border-green-500 transition shadow-sm resize-none" placeholder="Paste an image here or press Ctrl+V/Cmd+V while focused..."></textarea>
            </div>

            <div id="decodeStatus" class="p-3 mb-4 bg-yellow-50 text-yellow-800 rounded-lg hidden"></div>

            <div class="mt-8">
                <label class="block text-sm font-medium text-gray-700 mb-2">Decoded Content:</label>
                <div id="decodedOutput" class="p-4 bg-green-50 rounded-lg border border-green-300 min-h-[80px] text-gray-800 break-words select-all font-mono text-sm">
                    <span class="text-gray-400">Decoded text will appear here.</span>
                </div>
                <button onclick="copyDecodedText()" id="copyButton" class="mt-3 w-full px-4 py-2 bg-green-600 text-white font-semibold rounded-lg hover:bg-green-700 transition duration-150 shadow-md hover:shadow-lg focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-offset-2 disabled:opacity-50" disabled>
                    Copy Decoded Text
                </button>
            </div>
        </div>
    </main>

    <canvas id="qrCanvas" class="hidden"></canvas> <!-- Hidden canvas for image processing -->

    <script>
        // --- Firebase/API Placeholder Variables ---
        // Not used for this client-side utility, but required for the environment integrity.
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : '';
        // --- End Placeholder Variables ---


        const qrInput = document.getElementById('qrInput');
        const qrCodeSvg = document.getElementById('qrCodeSvg');
        const qrPlaceholder = document.getElementById('qrPlaceholder');
        const decodedOutput = document.getElementById('decodedOutput');
        const qrCanvas = document.getElementById('qrCanvas');
        const decodeStatus = document.getElementById('decodeStatus');
        const copyButton = document.getElementById('copyButton');
        const qrPasteArea = document.getElementById('qrPasteArea');

        // --- 1. QR CODE GENERATION (Text to Image) ---

        /**
         * Generates a QR code based on the input text and updates the SVG display.
         */
        function generateQRCode() {
            const text = qrInput.value.trim();

            if (!text) {
                showStatus('Please enter text or a URL to generate a QR code.', 'error');
                return;
            }

            try {
                // Clear previous content
                qrCodeSvg.innerHTML = '';
                qrCodeSvg.classList.add('hidden');
                qrPlaceholder.classList.add('hidden');

                // Create a new QR code SVG object
                const qr = new QRCode({ 
                    content: text,
                    padding: 4,
                    width: 300, 
                    height: 300,
                    color: "#1d4ed8", // Blue-700
                    background: "#ffffff",
                    // FIX: Changed Error Correction Level from 'M' (Medium) to 'L' (Low) 
                    // to increase the maximum data capacity from ~984 bytes to 1262 bytes.
                    ecl: "L", 
                });

                // Get the SVG string
                const svgString = qr.svg();
                
                // Create an <img> element using a data URL to enable right-click save/copy.
                const img = document.createElement('img');
                
                // Encode the SVG string to Base64
                const base64Svg = btoa(unescape(encodeURIComponent(svgString)));
                img.src = 'data:image/svg+xml;base64,' + base64Svg;
                
                img.alt = 'Generated QR Code';
                img.style.maxWidth = '300px';
                img.style.maxHeight = '300px';
                img.className = 'w-full h-full cursor-pointer'; 
                
                qrCodeSvg.appendChild(img);
                
                qrCodeSvg.classList.remove('hidden');
                showStatus('QR Code generated successfully! Capacity is now increased (Low Error Correction).', 'success');

            } catch (error) {
                console.error("Error generating QR code:", error);
                showStatus('Failed to generate QR code. The text may still exceed the maximum capacity (approx. 1262 chars).', 'error');
                qrPlaceholder.classList.remove('hidden');
            }
        }

        // --- 2. QR CODE DECODING (Image to Text) ---

        /**
         * Converts a File object (from input or paste) into an Image object.
         * @param {File} file - The image file.
         * @returns {Promise<HTMLImageElement>}
         */
        function fileToImage(file) {
            return new Promise((resolve, reject) => {
                if (!file || !file.type.startsWith('image/')) {
                    return reject(new Error("Invalid file type."));
                }
                const img = new Image();
                img.onload = () => resolve(img);
                img.onerror = () => reject(new Error("Failed to load image."));
                img.src = URL.createObjectURL(file);
            });
        }

        /**
         * Decodes a QR code from a loaded HTMLImageElement.
         * @param {HTMLImageElement} img - The image element.
         */
        function decodeImage(img) {
            const context = qrCanvas.getContext('2d');
            
            // Set canvas dimensions to the image dimensions
            qrCanvas.width = img.naturalWidth;
            qrCanvas.height = img.naturalHeight;

            // Draw the image onto the canvas
            context.drawImage(img, 0, 0, img.naturalWidth, img.naturalHeight);

            // Get image data from the canvas
            const imageData = context.getImageData(0, 0, qrCanvas.width, qrCanvas.height);

            // Use jsQR to find and decode the QR code
            const code = jsQR(imageData.data, imageData.width, imageData.height, {
                inversionAttempts: "dontInvert",
            });

            if (code) {
                decodedOutput.innerHTML = code.data;
                showStatus(`Successfully decoded: ${code.data.substring(0, 50)}...`, 'success');
                copyButton.disabled = false;
            } else {
                decodedOutput.innerHTML = '<span class="text-gray-400">No QR code found in the image. Try a clearer image.</span>';
                showStatus('Could not find a QR code.', 'warning');
                copyButton.disabled = true;
            }
        }

        /**
         * Handles the file input change event.
         */
        async function decodeQRCodeFromImage(event) {
            const file = event.target.files[0];
            if (!file) return;

            decodedOutput.innerHTML = '<span class="text-gray-400">Processing image...</span>';
            showStatus('Decoding...', 'info');
            copyButton.disabled = true;

            try {
                const img = await fileToImage(file);
                decodeImage(img);
            } catch (error) {
                console.error("Decoding error:", error);
                decodedOutput.innerHTML = '<span class="text-red-500">Error processing image.</span>';
                showStatus('Failed to load or process image.', 'error');
            }
        }
        
        /**
         * Handles image pasting into the paste area.
         */
        qrPasteArea.addEventListener('paste', async (event) => {
            event.preventDefault();
            
            let file = null;
            // Check for image data in the clipboard
            const items = event.clipboardData.items;
            for (let i = 0; i < items.length; i++) {
                if (items[i].type.indexOf('image') !== -1) {
                    file = items[i].getAsFile();
                    break;
                }
            }

            if (!file) {
                 showStatus('Clipboard did not contain an image file. Only image pastes are supported here.', 'warning');
                return;
            }

            // Clear the textarea visual cue
            qrPasteArea.value = 'Image pasted successfully. Decoding...';

            decodedOutput.innerHTML = '<span class="text-gray-400">Processing pasted image...';
            showStatus('Decoding pasted image...', 'info');
            copyButton.disabled = true;

            try {
                const img = await fileToImage(file);
                decodeImage(img);
            } catch (error) {
                console.error("Decoding error:", error);
                decodedOutput.innerHTML = '<span class="text-red-500">Error processing pasted image.</span>';
                showStatus('Failed to load or process pasted image.', 'error');
            } finally {
                // Clear the status text in the textarea after processing
                setTimeout(() => qrPasteArea.value = '', 1500);
            }
        });


        // --- 3. UTILITIES ---

        /**
         * Shows a temporary status message above the output field.
         * @param {string} message - The message to display.
         * @param {'success'|'error'|'warning'|'info'} type - The type of message.
         */
        function showStatus(message, type) {
            const styles = {
                success: 'bg-green-100 text-green-800 border-green-300',
                error: 'bg-red-100 text-red-800 border-red-300',
                warning: 'bg-yellow-100 text-yellow-800 border-yellow-300',
                info: 'bg-blue-100 text-blue-800 border-blue-300',
            };

            decodeStatus.className = `p-3 mb-4 rounded-lg border ${styles[type]} transition`;
            decodeStatus.innerHTML = message;
            decodeStatus.classList.remove('hidden');

            // Hide after 5 seconds
            clearTimeout(decodeStatus.timeout);
            decodeStatus.timeout = setTimeout(() => {
                decodeStatus.classList.add('hidden');
            }, 5000);
        }

        /**
         * Copies the decoded text to the clipboard.
         */
        function copyDecodedText() {
            const text = decodedOutput.textContent;
            if (text && text.trim() !== 'Decoded text will appear here.') {
                try {
                    // Use a temporary textarea for reliable copying in an iframe environment
                    const tempInput = document.createElement('textarea');
                    tempInput.value = text;
                    document.body.appendChild(tempInput);
                    tempInput.select();
                    document.execCommand('copy');
                    document.body.removeChild(tempInput);
                    showStatus('Copied text to clipboard!', 'success');
                } catch (err) {
                    console.error('Copy failed:', err);
                    showStatus('Copy failed. Please select and copy manually.', 'error');
                }
            }
        }
    </script>
</body>
</html>
